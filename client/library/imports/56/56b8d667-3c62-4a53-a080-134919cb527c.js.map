{"version":3,"sources":["..\\..\\..\\..\\assets\\Script/assets\\Script\\Login.js"],"names":["cc","Class","extends","Component","properties","btn_guest","default","type","Node","btn_phone","btn_wx","waiting_prefab","Prefab","tips_prefab","label_ver_error","Label","onLoad","ver_valid","token","sys","localStorage","getItem","waiting","instantiate","getComponent","init","parent","node","http","sendHall","method","platform","os","resp","setTimeout","id","removeItem","errmsg","tips","cs","getChildByName","mj","user","login","active","on","EventType","TOUCH_START","onGuestLogin","bind","onPhoneLogin","game_cfg","system_wx","_initWXLogin","wx_agent","anysdk","agentManager","wx_user_plugin","getUserPlugin","setListener","_WXLoginResult","onWXLogin","code","msg","UserActionResultCode","kInitSuccess","find","string","kInitFail","kLoginSuccess","WXLoginStatus","kLoginNetworkError","kLoginCancel","kLoginFail","JSON","parse"],"mappings":"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","file":"Login.js","sourceRoot":"..\\..\\..\\..\\assets\\Script","sourcesContent":["cc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        btn_guest: {\r\n            default: null,\r\n            type: cc.Node\r\n        },\r\n        btn_phone: {\r\n            default: null,\r\n            type: cc.Node\r\n        },\r\n        btn_wx: {\r\n            default: null,\r\n            type: cc.Node\r\n        },\r\n        waiting_prefab: {\r\n            default: null,\r\n            type: cc.Prefab\r\n        },\r\n        tips_prefab: {\r\n            default: null,\r\n            type: cc.Prefab\r\n        },\r\n        label_ver_error: cc.Label\r\n    },\r\n    onLoad: function () {\r\n        if (cc.ver_valid) {\r\n\r\n            let token = cc.sys.localStorage.getItem(\"token\")\r\n            if (token != null) {\r\n                let waiting = cc.instantiate(this.waiting_prefab)\r\n                waiting.getComponent(\"Waiting\").init(\"正在登陆\")\r\n                waiting.parent = this.node\r\n                http.sendHall({ method: \"token_login\", token: token, platform: cc.sys.os }, (resp) => {\r\n                    setTimeout(() => {\r\n                        waiting.parent = null\r\n                    }, 1000)\r\n                    if (resp.id == null) {\r\n                        cc.sys.localStorage.removeItem(\"token\")\r\n                        return\r\n                    }\r\n                    if (resp.errmsg) {\r\n                        let tips = cc.instantiate(this.tips_prefab)\r\n                        let cs = tips.getChildByName(\"Tips\").getComponent(\"Tips\")\r\n                        cs.init(resp.errmsg, \"OK\", () => { tips.parent = null; })\r\n                        tips.parent = this.node\r\n                    } else {\r\n                        cc.mj.user.login(resp)\r\n                    }\r\n                })\r\n            }\r\n            this.btn_guest.active = true\r\n            // if (cc.sys.isNative) {\r\n            //     this._initWXLogin()\r\n            // }else{\r\n            //     this.btn_guest.active = true\r\n            // }\r\n            this.btn_guest.on(cc.Node.EventType.TOUCH_START, this.onGuestLogin.bind(this))\r\n            this.btn_phone.on(cc.Node.EventType.TOUCH_START, this.onPhoneLogin.bind(this))\r\n        } else {\r\n            let tips = cc.instantiate(this.tips_prefab)\r\n            let cs = tips.getChildByName(\"Tips\").getComponent(\"Tips\")\r\n            cs.init(\"当前版本不可用，需重新下载新版本游戏，具体请联系官方微信：\" + cc.mj.game_cfg.system_wx, \"OK\", () => { tips.parent = null; })\r\n            tips.parent = this.node\r\n        }\r\n    },\r\n    _initWXLogin: function () {\r\n        this.wx_agent = anysdk.agentManager;\r\n        this.wx_user_plugin = this.wx_agent.getUserPlugin();\r\n        this.wx_user_plugin.setListener(this._WXLoginResult.bind(this));\r\n        this.btn_wx.active = true\r\n        this.btn_wx.on(cc.Node.EventType.TOUCH_START, this.onWXLogin.bind(this))\r\n    },\r\n    _WXLoginResult: function (code, msg) {\r\n        switch (code) {\r\n            case anysdk.UserActionResultCode.kInitSuccess://初始化 SDK 成功回调\r\n                cc.find(\"Canvas/log\").getComponent(cc.Label).string = \"kInitSuccess\"\r\n                //SDK 初始化成功，login方法需要在初始化成功之后调用\r\n                break;\r\n            case anysdk.UserActionResultCode.kInitFail://初始化 SDK 失败回调\r\n                cc.find(\"Canvas/log\").getComponent(cc.Label).string = \"kInitFail\"\r\n                //SDK 初始化失败，游戏相关处理\r\n                break;\r\n            case anysdk.UserActionResultCode.kLoginSuccess: //登陆成功回调\r\n                this.WXLoginStatus(msg)\r\n                //登陆成功后，可使用getUserID()获取用户ID\r\n                break;\r\n            case anysdk.UserActionResultCode.kLoginNetworkError: //登陆网络出错回调\r\n            case anysdk.UserActionResultCode.kLoginCancel: //登陆取消回调\r\n            case anysdk.UserActionResultCode.kLoginFail: //登陆失败回调\r\n                //登陆失败后，游戏相关处理\r\n                break;\r\n        }\r\n    },\r\n    onGuestLogin: function () {\r\n        let token = cc.sys.localStorage.getItem(\"token\")\r\n        if (token != null) {\r\n            http.sendHall({ method: \"token_login\", token: token, platform: cc.sys.os }, (resp) => {\r\n                if (resp.id == null) {\r\n                    cc.sys.localStorage.removeItem(\"token\")\r\n                    return\r\n                }\r\n                cc.mj.user.login(resp)\r\n            })\r\n        } else {\r\n            http.sendHall({ method: \"guest_login\" }, (resp) => {\r\n                if (resp.id == null) {\r\n                    return\r\n                }\r\n                cc.mj.user.login(resp)\r\n            })\r\n        }\r\n    },\r\n    onPhoneLogin: function () {\r\n    },\r\n\r\n    onWXLogin: function () {\r\n        this.wx_user_plugin.login();\r\n        this.waiting = cc.instantiate(this.waiting_prefab)\r\n        this.waiting.getComponent(\"Waiting\").init(\"正在登陆\")\r\n        this.waiting.parent = this.node\r\n        setTimeout(() => {\r\n            this.waiting && (this.waiting.parent = null)\r\n        }, 3000);\r\n    },\r\n    WXLoginStatus: function (msg) {\r\n        let resp = JSON.parse(msg)\r\n        cc.mj.user.login(resp)\r\n    },\r\n    // LIFE-CYCLE CALLBACKS:\r\n\r\n    // onLoad () {},\r\n\r\n    // start () {\r\n\r\n    // },\r\n\r\n    // update (dt) {},\r\n});\r\n"]}